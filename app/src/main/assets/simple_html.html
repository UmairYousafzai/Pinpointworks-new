<!DOCTYPE html>
<html>
<head>
    <title>outputdir</title>
    <meta http-equiv="imagetoolbar" content="no"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="file:///android_asset/Quill/quill.js" type="text/javascript"></script>
    <script src="file:///android_asset/Quill/quill-mention.js" type="text/javascript"></script>

    <link rel="stylesheet" href="file:///android_asset/Quill/quill.snow.css">
    <link rel="stylesheet" href="file:///android_asset/Quill/quill.mention.css">

    <style type="text/css">
        html, body {
            margin:0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            background: #FFFFFF;
        }

        /* The snackbar - position it at the bottom and in the middle of the screen */
        .snackbar {
          visibility: hidden; /* Hidden by default. Visible on click */
          width: 60%; /* Set a default minimum width */
          background-color: #333; /* Black background color */
          color: #fff; /* White text color */
          text-align: center; /* Centered text */
          border-radius: 2px; /* Rounded borders */
          padding: 16px; /* Padding */
          position: fixed; /* Sit on top of the screen */
          z-index: 1; /* Add a z-index if needed */
          left: 50%;
          transform: translateX(-50%);
          bottom: 30px; /* 30px from the bottom */
        }

        #textLimitExceeded.showSnackbar {
          visibility: visible; /* Show the snackbar */
          -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein {
          from {bottom: 0; opacity: 0;}
          to {bottom: 30px; opacity: 1;}
        }
        @-webkit-keyframes fadeout {
          from {bottom: 30px; opacity: 1;}
          to {bottom: 0; opacity: 0;}
        }

        .ql-editor {
            font-family: Roboto;
            font-size: 16px;
            color: black;
            font-weight: 400;
        }

        .ql-editor, .ql-container, .ql-snow {
            border: none !important;
        }

        .ql-tooltip, .ql-editing {
            position: absolute;
            left: 5% !important;
            right: 5% !important;
            bottom: 5% !important;
            padding: 4px 0px;
            margin: 0;
            height: 40px;
            max-width: 90%;
        }

        .ql-editor.ql-blank:focus::before {
          content: '';
        }

        input {
            width: 60% !important;
        }

        .ql-tooltip:before {
            margin-right: 5px;
            text-align: center;
            float: left;
        }

        .ql-snow .ql-tooltip a.ql-action:after {
            float: right;
            text-align: center;
            margin-left: 5px;
        }

        .mention {
            background-color: #e9f3fc;
            border-radius: 5px;
            color: #0084f8;
            padding: 0 4px;
            font-family: Roboto;
            font-size: 16px;
            font-weight: 400;
        }

        .users__select__details {
            max-width: 100%;
            padding-top: 5px;
            padding-bottom: 10px;
            padding-left: 0;
        }

        .users__select_userName {
          text-overflow: ellipsis;
          white-space: nowrap;
          overflow: hidden;
          line-height: 18px;
          font-size: 16px;
          color: black;
          font-family: Roboto;
        }

        .users__select_userEmail {
          text-overflow: ellipsis;
          white-space: nowrap;
          overflow: hidden;
          line-height: 18px;
          hyphens: auto;
          list-style-type: none;
          font-size: 16px;
          color: #6E7881;
          font-family: Roboto;
        }

        .users__item {
          width: 100%;
          display: flex;
          border-radius: 3px;
          list-style-type: none;
          border: 0;
          padding: 0;
          margin-left: 0;
          outline: none;
          background: unset;
        }

        .ql-mention-list-container {
            position: absolute;
            left: 5% !important;
            right: 5% !important;
            margin-top: 6px;
            max-width: 100%;
            max-height: 60%;
        }

        li, .ql-mention-list-item.selected {
            background-color: white;
        }

        .usersDropdown {
          max-height: 60%;
        }

        .counter {
            width: 100% !important;
            font-family: Roboto;
            font-size: 14px;
            float: right;
            text-align: right;
            margin: 0;
        }

        .counter-gray {
            padding: 4px 10px 4px 0;
            color: rgba(70, 80, 88, 1);
            background-color: rgba(70, 80, 88, 0.15);
            height: 14px;
        }

        .counter-red {
            padding: 4px 10px 4px 0;
            color: rgba(228, 80, 80, 1);
            background-color: rgba(228, 80, 80, 0.15);
            height: 14px;
        }

        .counter-hidden {
            padding: 0;
            visibility: hidden;
            height: 0;
        }

    </style>
</head>

<body>


<div id="quill-editor" style="height: calc(100vh - 45px);">
    <div id="editor"></div>
</div>

<div id="counter" class="counter counter-hidden"></div>

<div id="separator" style="height:1px; background-color:#DCE1E4;margin-top:0;"></div>

<div id="commentToolbar" style="width: 100%;">
    <button class="ql-bold" style="width: 12.5%; height: 30px;"></button>
    <button class="ql-italic" style="width: 12.5%; height: 30px;"></button>
    <button class="ql-underline" style="width: 12.5%; height: 30px;"></button>
    <button class="ql-strike" style="width: 12.5%; height: 30px;"></button>
    <button class="ql-link" style="width: 12.5%; height: 30px;"></button>
    <button class="ql-list" value="ordered" style="width: 12.5%; height: 30px;"></button>
    <button class="ql-list" value="bullet" style="width: 12.5%; height: 30px;"></button>
    <button onclick="showMentionsDropdown()" style="width: 12.5%; height: 30px; font-size: 20px; font-weight: bold; color: #585858; margin: auto; padding: 0;">@</button>
</div>

<div id="textLimitExceeded" class="snackbar"></div>

<script type="text/javascript">

    const toolbar = document.getElementById("commentToolbar");

    const mentionModule = {
        mentionDenotationChars: ['@'],
        source: (searchTerm, renderList) => {
          const values = userList;
          if (searchTerm.length === 0) {
            renderList(values, searchTerm);
          } else {
            const matches = [];
            for (let i = 0; i < values.length; i++) {

              if (~values[i].value.toLowerCase().indexOf(searchTerm.toLowerCase())) {
                matches.push(values[i]);
              }
            }
            renderList(matches, searchTerm);
          }
        },
        positioningStrategy: 'fixed',
        isolateCharacter: true,
        renderItem: ((item, searchTerm) => {
          const listItem = (
            `<li class="users__item">
              <ul class="users__select__details">
                <li class="users__select_userName">
                    ${ item.value }
                </li>
                <li class="users__select_userEmail">
                  ${ item.email }
                </li>
              </ul>
            </li>`
          );
          return listItem;
        }),
      };

    var quill = new Quill('#editor', {
        modules: {
          toolbar: toolbar,
          mention: mentionModule,
        },
        theme: 'snow',
        placeholder: "Enter text...",
    });

    let textLength = 0;

    quill.on('text-change', function(delta, oldDelta, source) {
        const richTextComponent = quill.getContents();
        let mergedText = '';

        richTextComponent.ops.forEach(textLine => {
            if (typeof textLine.insert === 'string') {
                mergedText += textLine.insert;
            } else if (textLine.insert.mention) {
                mergedText += '@' + textLine.insert.mention.value;
            }
        });
        textLength = mergedText.length;

        let counter = document.getElementById("counter");
        counter.innerHTML = textLength + "/" + textLimit;

        if (textLength > textLimit) {
            counter.classList.remove('counter-gray');
            counter.classList.remove('counter-hidden');
            counter.classList.add('counter-red');
            document.getElementById("separator").style.marginTop = "21px";
            document.getElementById("quill-editor").style.height = "calc(100vh - 66px)";
        } else if (textLength >= (textLimit - 500)) {
            counter.classList.remove('counter-red');
            counter.classList.remove('counter-hidden');
            counter.classList.add('counter-gray');
            document.getElementById("separator").style.marginTop = "21px";
            document.getElementById("quill-editor").style.height = "calc(100vh - 66px)";
        } else {
            counter.classList.add('counter-hidden');
            document.getElementById("separator").style.marginTop = "0";
            document.getElementById("quill-editor").style.height = "calc(100vh - 45px)";
        }
    });

    var existingMentions = [];

    function showMentionsDropdown() {
        quill.getModule('mention').openMenu(' @');
    }

    function checkExistingMentions() {
        if (quill) {
            const richTextComponent = this.quill.getContents();
            existingMentions = [];
            richTextComponent.ops.forEach(textLine => {
                if (textLine.insert && textLine.insert.mention) {
                    this.existingMentions.push(textLine.insert.mention.id);
                }
            });
        }
    }

    function getPlanTextValue() {
        let mergedText = '';
        const richTextComponent = this.quill.getContents();
        richTextComponent.ops.forEach(textLine => {
            mergedText += textLine.insert;
<!--              if (typeof textLine.insert === 'string') {-->
<!--                mergedText += textLine.insert;-->
<!--              } else if (textLine.insert.mention) {-->
<!--                mergedText += '@' + textLine.insert.mention.value;-->
<!--              }-->
        });
        return mergedText;
    }

    function onSaveValue() {
        if (textLength > textLimit) {
            showTextLimitExceededSnackbar();
            return;
        }

        let plainText = getPlanTextValue();

        let contents = quill.getContents();
        let base64Value = btoa(unescape(encodeURIComponent(JSON.stringify(contents))));

        let mentions = [];
        let alreadyMentioned = existingMentions;
        checkExistingMentions();
        for (let mention of existingMentions) {
            if (!alreadyMentioned.includes(mention) && !mentions.includes(mention)) {
                mentions.push(mention);
            }
        }

        Android.getValue(plainText, base64Value, mentions);

    }

    function showTextLimitExceededSnackbar() {
        var snackbar = document.getElementById('textLimitExceeded');
        snackbar.classList.add('showSnackbar');
        snackbar.innerHTML = "The maximum length of text is " + textLimit + ".";

        setTimeout(function(){
            snackbar.classList.remove('showSnackbar');
        }, 2800);
    }
let textLimit = 10000;
const jsonValue = "{\"ops\":[{\"insert\":\"This is the description\\n\"}]}";
let userList =  [
{
id:"d8da97e813a5c09ed314916e217787d2",
value:"Valerio",
avatar:"d8da97e813a5c09ed314916e2177a171",
email:"lillospillo70@gmail.com",
},
{
id:"5a1f906a5ae6ecf5519d14eba2646ffe",
value:"James Stockdale",
avatar:"d4fda41e415d494abc48372a456d5a0c",
email:"developers+d1b44fb7b106af6dde810f411dd98577@pinpointworks.com",
},
{
id:"07d9bb4e221142cefc14246feed053b4",
value:"Leslie Gillotte",
avatar:"8f4341bbcb7983e061d589734798f30f",
email:"leslierg18@gmail.com",
},
{
id:"5d09c3cda6175a3bddd331463d614d15",
value:"James Stockdale",
avatar:"ed0ddfb7e4ee58a0522b315c6bda3148",
email:"james@pinpointworks.com",
},
{
id:"974a3f6fb52aed74a2f6158f96b8b15c",
value:"Leslie PW",
avatar:"ec820c8975dcc41ee11640b051244689",
email:"leslie@pinpointworks.com",
},
{
id:"d8da97e813a5c09ed314916e216d019a",
value:"Amjad 159",
avatar:"68a4586bdc875256beeb6b42",
email:"amjad@pinpointworks.com",
},
{
id:"d88ed28bdf9678eead814275371f2e06",
value:"Amjad khan 4",
avatar:"d88ed28bdf9678eead814275371f43f8",
email:"amjadislamkhan+4@gmail.com",
},
{
id:"8eb759a28b0430d22cbecee9091a1515",
value:"Ross Shelford ",
avatar:"8eb759a28b0430d22cbecee9091a5edf",
email:"ross@pinpointworks.com",
},
];
const richTextComponent = JSON.parse(jsonValue);
this.quill.setContents(richTextComponent.ops);
checkExistingMentions();
</script> </body> </html>